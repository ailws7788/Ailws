<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SolarTech Estimator</title>

  <!-- Leaflet æ ·å¼ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Leaflet.draw æ ·å¼ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f1f8fc; margin:0; padding:20px; color:#333; }
    .container { max-width:700px; margin:auto; background:#fff; padding:30px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align:center; color:#0077cc; margin-bottom:20px; }
    label,input,button { display:block; width:100%; margin-top:10px; font-size:16px; }
    input { padding:10px; border:1px solid #ccc; border-radius:6px; }
    button { margin-top:15px; padding:12px; background:#0077cc; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    #output { display:none; margin-top:30px; }
    #roofMap { height:400px; width:100%; margin-top:20px; border:1px solid #ccc; border-radius:8px; }
  </style>
</head>
<body>

  <div class="container">
    <img src="logo.jpg" onerror="this.onerror=null;this.src='images/logo.png';"
         alt="SolarTech Logo" style="width:200px; display:block; margin:0 auto 10px;"/>
    <h2>ğŸ”† Solar Savings Estimator</h2>

    <label for="customer">Customer Name:</label>
    <input id="customer" placeholder="e.g. John Tan"/>

    <label for="location">Installation Location:</label>
    <input id="location" placeholder="è¾“å…¥æˆ–è‡ªåŠ¨æ£€æµ‹ä½ç½®"/>

    <label for="bill">Enter your monthly TNB bill (RM):</label>
    <input id="bill" type="number" placeholder="e.g. 600"/>

    <button onclick="calculate()">Calculate &amp; Draw Panels</button>

    <div id="output"></div>
  </div>

  <!-- åœ°å›¾å®¹å™¨ -->
  <div id="roofMap"></div>

  <!-- Leaflet & Draw è„šæœ¬ -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script>
    // è‡ªåŠ¨å®šä½å¡«å…… location è¾“å…¥æ¡†
    window.addEventListener('load', () => {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6),
              lon = pos.coords.longitude.toFixed(6),
              url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
        fetch(url).then(r=>r.json()).then(data=>{
          const el = document.getElementById('location');
          if (!el.value) el.value = `(${lat}, ${lon}) `+(data.display_name||'');
        });
      });
    });

    let map, drawnItems;

    function calculate() {
      // éšè—è¾“å‡ºåŒº
      document.getElementById('output').style.display = 'none';
      // å…ˆåˆå§‹åŒ–æˆ–é‡ç½®åœ°å›¾
      initMap();

      // è¿™é‡Œå¯ä»¥æ”¾æ›´å¤šè®¡ç®—ç»“æœåˆ° outputâ€¦â€¦
      document.getElementById('output').innerHTML = '<p>è¯·ç”¨å·¦ä¾§ç”»ç¬”å·¥å…·åœ¨åœ°å›¾ä¸Šæ¡†é€‰å±‹é¡¶åŒºåŸŸã€‚</p>';
      document.getElementById('output').style.display = 'block';
    }

    function initMap() {
      if (map) map.remove();  // æ¸…é™¤æ—§åœ°å›¾
      map = L.map('roofMap').setView([4.5774,101.1275], 19);

      // å«æ˜Ÿåº•å›¾
      L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { attribution:'Tiles Â© Esri', maxZoom: 19 }
      ).addTo(map);

      // ç”»å›¾å›¾å±‚
      drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      // Draw æ§ä»¶
      const drawControl = new L.Control.Draw({
        draw: { polyline:false, circle:false, circlemarker:false, marker:false, rectangle:false, polygon:{allowIntersection:false, showArea:true} },
        edit: { featureGroup: drawnItems, remove:true }
      });
      map.addControl(drawControl);

      // åˆ›å»ºå®Œæˆæ—¶ç»˜åˆ¶é¢æ¿
      map.on(L.Draw.Event.CREATED, function(e){
        drawnItems.clearLayers();
        const polygon = e.layer;
        drawnItems.addLayer(polygon);
        drawPanels(polygon);
      });
    }

    // åœ¨å¤šè¾¹å½¢å†…éƒ¨ç­‰è·é“ºæ’é¢æ¿ï¼ˆç¤ºä¾‹ï¼šæ¯å—çº¦0.00004åº¦å¤§å°ï¼‰
    function drawPanels(polygon) {
      const bounds = polygon.getBounds();
      const dx = 0.00004, dy = 0.00004;

      for (let lat=bounds.getSouth(); lat<bounds.getNorth(); lat+=dy) {
        for (let lon=bounds.getWest(); lon<bounds.getEast(); lon+=dx) {
          const pt = L.latLng(lat, lon);
          if (polygon.getBounds().contains(pt) && polygon.getLatLngs()[0].some(polyPt=>polygon.contains(pt))) {
            // ç”¨é»„è‰²åŠé€æ˜çŸ©å½¢è¡¨ç¤ºé¢æ¿
            const sw = [lat, lon], ne = [lat+dy, lon+dx];
            L.rectangle([sw, ne], {color:'#ffaa00', weight:1, fillOpacity:0.6}).addTo(map);
          }
        }
      }
    }
  </script>
</body>
</html>
