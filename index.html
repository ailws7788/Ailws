<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SolarTech Estimator</title>
  <link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
  <style>
    body { font-family:'Segoe UI',sans-serif; background:#f1f8fc; padding:20px; color:#333; }
    .container { max-width:700px; margin:auto; background:#fff; padding:30px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align:center; color:#0077cc; margin-bottom:20px; }
    label,input,button { display:block; width:100%; margin-top:10px; font-size:16px; }
    input { padding:10px; border:1px solid #ccc; border-radius:6px; }
    input[readonly] { background:#eee; }
    button { margin-top:15px; padding:12px; background:#0077cc; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    #output { display:none; margin-top:30px; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th,td { padding:10px; border:1px solid #ddd; }
    th { background:#f4f4f4; text-align:left; }
    #roofMap { height:400px; width:100%; margin-top:20px; border:1px solid #ccc; border-radius:8px; }
    .arrow-label { font-size:24px; font-weight:bold; color:red; text-align:center; }
  </style>
</head>
<body>

  <div class="container">
    <div style="text-align:center;">
      <img src="logo.jpg" onerror="this.onerror=null;this.src='images/logo.png';"
           alt="Logo" style="max-width:160px; border-radius:6px; margin-bottom:10px;"/>
      <h2>üîÜ Solar Savings Estimator</h2>
    </div>

    <div id="formArea">
      <label for="customer">Customer Name:</label>
      <input id="customer" placeholder="e.g. John Tan" type="text"/>

      <label for="location">Installation Location:</label>
      <input id="location" placeholder="Detecting..." readonly type="text"/>

      <label for="bill">Enter your monthly TNB bill (RM):</label>
      <input id="bill" placeholder="e.g. 600" type="number"/>

      <button onclick="calculate()">Calculate &amp; Show Map</button>
    </div>

    <div id="output"></div>
  </div>

  <div id="roofMap"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Ëá™Âä®Ê£ÄÊµãÂÆö‰ΩçÂπ∂Â°´ÂÖÖ location ËæìÂÖ•Ê°Ü
    window.addEventListener('load', () => {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6),
              lng = pos.coords.longitude.toFixed(6);
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
          .then(r=>r.json())
          .then(data => {
            const inp = document.getElementById('location');
            if (!inp.value) inp.value = `(${lat}, ${lng}) ` + (data.display_name||'');
          })
          .catch(()=>{
            const inp = document.getElementById('location');
            if (!inp.value) inp.value = `(${lat}, ${lng})`;
          });
      }, () => console.warn('ÂÆö‰ΩçÂ§±Ë¥•ÊàñË¢´ÊãíÁªù'));
    });

    let map, panelCount;

    function calculate() {
      const cust = document.getElementById('customer').value||'N/A';
      const loc  = document.getElementById('location').value||'N/A';
      const bill = parseFloat(document.getElementById('bill').value);
      if (isNaN(bill)||bill<=0) return alert('ËØ∑ËæìÂÖ•ÊúâÊïàË¥¶ÂçïÈáëÈ¢ù');

      // ËÆ°ÁÆóÂü∫Êú¨ÂèÇÊï∞
      const kWh = bill/0.5;
      let sysSize = kWh/130;
      const lb = Math.floor(sysSize);
      if (sysSize >= lb+0.23) sysSize = lb+1;

      panelCount = Math.ceil(sysSize/0.62);
      const estCost = 'RM '+(sysSize* (sysSize>=10?2850:sysSize>=9?3100:sysSize>=8?3400:sysSize>=7?3600:sysSize>=6?4000:4500)).toLocaleString('en-MY');
      const roofSpace = (panelCount*4*8).toFixed(0);

      document.getElementById('formArea').style.display='none';
      const out = document.getElementById('output');
      out.style.display='block';
      out.innerHTML = `
        <h3>üìã Result Summary</h3>
        <table>
          <tr><th>Customer Name</th><td>${cust}</td></tr>
          <tr><th>Location</th><td>${loc}</td></tr>
          <tr><th>Current Bill</th><td>RM ${bill.toFixed(2)}</td></tr>
          <tr><th>Panel Count</th><td>${panelCount} units</td></tr>
          <tr><th>Est. System Cost</th><td style="color:#cc3300;font-weight:bold;">${estCost}</td></tr>
          <tr><th>Roof Space Needed</th><td>${roofSpace} sq ft</td></tr>
        </table>`;
      initMap();
    }

    function initMap() {
      // Ëß£Êûê‰ΩçÁΩÆ
      let center = [4.5746,101.1275];
      const locVal = document.getElementById('location').value;
      const m = locVal.match(/\(([-\d.]+),\s*([-\d.]+)\)/);
      if (m) center = [+m[1],+m[2]];

      if (map) map.remove();
      map = L.map('roofMap').setView(center, 19);

      // Mapbox Âç´ÊòüÂ∫ïÂõæ
      const token = 'pk.eyJ1IjoibWFjY2hlYW5nNzY4NyIsImEiOiJjbWM3ZHB0cnMwa2ozMm9xMjV6YmM1Mnc0In0.9OOlFHdyLY7SlPphMQt6XQ';
      L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${token}`, {
        tileSize:512, zoomOffset:-1, attribution:'&copy; Mapbox'
      }).addTo(map);

      // Â±ãÈ°∂‰∏≠ÂøÉÊ†áËÆ∞
      L.marker(center).addTo(map).bindPopup('Your Roof').openPopup();
      }
    }
  </script>
</body>
</html>
